# 前端报错监控与处理

> 前端报错监控与处理是保障应用稳定性、提升用户体验的关键环节。本文详细介绍前端常见报错类型、监控方法、处理流程及最佳实践，帮助开发者快速定位和解决问题。

## 概念介绍

前端报错指Web应用在运行过程中出现的异常情况，可能导致功能失效或用户体验下降。有效的监控与处理机制能及时发现问题，缩短故障恢复时间，提升应用可靠性。

## 核心特性

### 1. 常见报错类型
- **JS运行时错误**：如未定义变量、类型错误（TypeError）、引用错误（ReferenceError）等。
- **资源加载错误**：CSS/JS文件、图片等资源加载失败（如404错误）。
- **接口请求错误**：HTTP请求失败（如500状态码、网络超时）。
- **Promise未捕获异常**：未通过`.catch()`处理的Promise拒绝。

### 2. 监控方法
- **原生API捕获**：使用`window.onerror`监听全局JS错误，`window.addEventListener('error', ...)`捕获资源加载错误，`window.addEventListener('unhandledrejection', ...)`捕获未处理的Promise拒绝。
- **第三方工具**：如Sentry（集成简单，提供详细堆栈信息）、Bugly（适合移动端Web）、New Relic（全栈监控）。
- **自定义埋点**：通过封装`fetch`/`XMLHttpRequest`监控接口错误，结合`MutationObserver`监控DOM异常。

### 3. 处理流程
1. **错误捕获**：通过上述方法实时捕获各类错误。
2. **信息上报**：将错误信息（如错误类型、堆栈、用户信息、环境信息）通过`Beacon API`或`XMLHttpRequest`发送至后端。
3. **数据存储与分析**：后端存储错误数据，通过日志系统（如ELK）或监控平台（如Grafana）进行可视化分析。
4. **问题定位与修复**：根据错误堆栈和上下文信息定位代码问题，修复后发布新版本并验证。

## 实战案例

### 使用Sentry监控前端报错
1. **集成Sentry**：
```javascript
import * as Sentry from "@sentry/browser";
import { BrowserTracing } from "@sentry/tracing";

Sentry.init({
  dsn: "YOUR_DSN",
  integrations: [new BrowserTracing()],
  tracesSampleRate: 1.0,
});
```

2. **捕获自定义错误**：
```javascript
try {
  // 可能出错的代码
} catch (error) {
  Sentry.captureException(error); // 手动上报错误
}
```

3. **监控接口错误**：
```javascript
// 封装fetch
const originalFetch = window.fetch;
window.fetch = async (...args) => {
  try {
    const response = await originalFetch(...args);
    if (!response.ok) {
      Sentry.captureMessage(`接口请求失败：${response.url}，状态码：${response.status}`);
    }
    return response;
  } catch (error) {
    Sentry.captureException(error);
    throw error;
  }
};
```

## 兼容性说明

- **原生API**：`window.onerror`、`unhandledrejection`事件在现代浏览器（Chrome 55+、Firefox 53+、Safari 11+、Edge 17+）中均支持，旧浏览器可能存在部分限制。
- **第三方工具**：Sentry支持主流浏览器（Chrome 60+、Firefox 57+、Safari 12+、Edge 79+），旧浏览器可能需要polyfill。

## 面试常见问题

### 1. 如何区分JS运行时错误和资源加载错误？
**答**：可以通过事件类型区分：`window.onerror`可以捕获JS运行时错误（错误对象包含`message`、`filename`、`lineno`等属性）；资源加载错误（如图片加载失败）需要通过`window.addEventListener('error', ...)`监听，此时事件对象的`target`为加载失败的资源元素（如`<img>`）。

### 2. 为什么建议使用`Beacon API`上报错误？
**答**：`Beacon API`（`navigator.sendBeacon`）使用低优先级的HTTP请求，不会阻塞页面卸载或导航，适合在页面关闭前上报错误数据，相比`XMLHttpRequest`或`fetch`更可靠。

### 3. 如何避免监控代码本身成为性能瓶颈？
**答**：可以采用抽样上报（如仅10%用户上报数据）、延迟上报（利用`requestIdleCallback`在浏览器空闲时上报）或分优先级上报（核心错误实时上报，次要错误批量上报）。