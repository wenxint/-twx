# ä¸€é”®æ¢è‚¤

> ä¸€é”®æ¢è‚¤æ˜¯ç°ä»£Webåº”ç”¨ä¸­å¸¸è§çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿæå‡ç”¨æˆ·ä½“éªŒï¼Œæ»¡è¶³ä¸åŒç”¨æˆ·çš„è§†è§‰åå¥½ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»ä¸»æµçš„æ¢è‚¤å®ç°æ–¹æ¡ˆï¼Œå¹¶æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚

## åŸºæœ¬æ¦‚å¿µ

ä¸€é”®æ¢è‚¤åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨é¢„è®¾çš„å¤šå¥—UIä¸»é¢˜ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š
- **æ˜æš—ä¸»é¢˜åˆ‡æ¢**ï¼šLight/Darkæ¨¡å¼
- **å¤šè‰²å½©ä¸»é¢˜**ï¼šä¸åŒçš„é…è‰²æ–¹æ¡ˆ
- **å­—ä½“å¤§å°è°ƒæ•´**ï¼šé€‚åº”ä¸åŒç”¨æˆ·éœ€æ±‚
- **å¸ƒå±€é£æ ¼å˜åŒ–**ï¼šç´§å‡‘/å®½æ¾å¸ƒå±€

## æ ¸å¿ƒå®ç°æ–¹æ¡ˆ

### 1. CSSå˜é‡æ–¹æ¡ˆï¼ˆæ¨èï¼‰

CSSå˜é‡æ˜¯æœ€ç°ä»£åŒ–çš„æ¢è‚¤è§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰è‰¯å¥½çš„æµè§ˆå™¨æ”¯æŒå’Œçµæ´»æ€§ã€‚

```css
/* ä¸»é¢˜å˜é‡å®šä¹‰ */
:root {
  /* é»˜è®¤æµ…è‰²ä¸»é¢˜ */
  --primary-color: #1976d2;
  --secondary-color: #dc004e;
  --bg-color: #ffffff;
  --text-color: #333333;
  --border-color: #e0e0e0;
  --shadow-color: rgba(0, 0, 0, 0.1);
}

/* æ·±è‰²ä¸»é¢˜ */
[data-theme="dark"] {
  --primary-color: #90caf9;
  --secondary-color: #f48fb1;
  --bg-color: #121212;
  --text-color: #ffffff;
  --border-color: #333333;
  --shadow-color: rgba(255, 255, 255, 0.1);
}

/* è“è‰²ä¸»é¢˜ */
[data-theme="blue"] {
  --primary-color: #2196f3;
  --secondary-color: #ff9800;
  --bg-color: #f3f8ff;
  --text-color: #1a1a1a;
  --border-color: #b3d9ff;
  --shadow-color: rgba(33, 150, 243, 0.2);
}

/* åº”ç”¨å˜é‡åˆ°ç»„ä»¶ */
.app {
  background-color: var(--bg-color);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 8px var(--shadow-color);
  transition: all 0.3s ease;
}

.button {
  background-color: var(--primary-color);
  color: var(--bg-color);
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  transition: all 0.3s ease;
}

.button:hover {
  opacity: 0.8;
}
```

### 2. ä¸»é¢˜åˆ‡æ¢é€»è¾‘å®ç°

```javascript
/**
 * @description ä¸»é¢˜ç®¡ç†å™¨ç±»
 * @class ThemeManager
 */
class ThemeManager {
  constructor() {
    this.themes = ['light', 'dark', 'blue'];
    this.currentTheme = 'light';
    this.storageKey = 'user-theme';

    // åˆå§‹åŒ–ä¸»é¢˜
    this.init();
  }

  /**
   * @description åˆå§‹åŒ–ä¸»é¢˜ï¼Œä»localStorageè¯»å–ç”¨æˆ·åå¥½
   */
  init() {
    // 1. ä¼˜å…ˆè¯»å–æœ¬åœ°å­˜å‚¨çš„ä¸»é¢˜
    const savedTheme = localStorage.getItem(this.storageKey);

    // 2. æ£€æµ‹ç³»ç»Ÿä¸»é¢˜åå¥½
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    // 3. ç¡®å®šåˆå§‹ä¸»é¢˜
    this.currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');

    // 4. åº”ç”¨ä¸»é¢˜
    this.applyTheme(this.currentTheme);

    // 5. ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
    this.watchSystemTheme();
  }

  /**
   * @description åº”ç”¨æŒ‡å®šä¸»é¢˜
   * @param {string} theme - ä¸»é¢˜åç§°
   */
  applyTheme(theme) {
    if (!this.themes.includes(theme)) {
      console.warn(`Unknown theme: ${theme}`);
      return;
    }

    // ç§»é™¤ä¹‹å‰çš„ä¸»é¢˜ç±»
    document.documentElement.removeAttribute('data-theme');

    // åº”ç”¨æ–°ä¸»é¢˜
    if (theme !== 'light') {
      document.documentElement.setAttribute('data-theme', theme);
    }

    this.currentTheme = theme;

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem(this.storageKey, theme);

    // è§¦å‘ä¸»é¢˜å˜åŒ–äº‹ä»¶
    this.dispatchThemeChange(theme);
  }

  /**
   * @description åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä¸»é¢˜
   */
  toggleTheme() {
    const currentIndex = this.themes.indexOf(this.currentTheme);
    const nextIndex = (currentIndex + 1) % this.themes.length;
    const nextTheme = this.themes[nextIndex];

    this.applyTheme(nextTheme);
  }

  /**
   * @description è·å–å½“å‰ä¸»é¢˜
   * @returns {string} å½“å‰ä¸»é¢˜åç§°
   */
  getCurrentTheme() {
    return this.currentTheme;
  }

  /**
   * @description ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
   */
  watchSystemTheme() {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

    mediaQuery.addEventListener('change', (e) => {
      // åªæœ‰åœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ä¸»é¢˜æ—¶æ‰è‡ªåŠ¨åˆ‡æ¢
      if (!localStorage.getItem(this.storageKey)) {
        this.applyTheme(e.matches ? 'dark' : 'light');
      }
    });
  }

  /**
   * @description æ´¾å‘ä¸»é¢˜å˜åŒ–äº‹ä»¶
   * @param {string} theme - æ–°ä¸»é¢˜åç§°
   */
  dispatchThemeChange(theme) {
    const event = new CustomEvent('themechange', {
      detail: { theme, previousTheme: this.currentTheme }
    });

    window.dispatchEvent(event);
  }

  /**
   * @description é‡ç½®ä¸ºç³»ç»Ÿä¸»é¢˜
   */
  resetToSystemTheme() {
    localStorage.removeItem(this.storageKey);
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    this.applyTheme(prefersDark ? 'dark' : 'light');
  }
}

// åˆ›å»ºå…¨å±€ä¸»é¢˜ç®¡ç†å™¨å®ä¾‹
const themeManager = new ThemeManager();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.themeManager = themeManager;
```

### 3. React Hookå®ç°

```javascript
import { useState, useEffect, useCallback } from 'react';

/**
 * @description Reactä¸»é¢˜ç®¡ç†Hook
 * @returns {Object} ä¸»é¢˜çŠ¶æ€å’Œæ§åˆ¶æ–¹æ³•
 */
export function useTheme() {
  const [theme, setTheme] = useState('light');
  const [themes] = useState(['light', 'dark', 'blue']);

  /**
   * @description åº”ç”¨ä¸»é¢˜åˆ°DOM
   */
  const applyTheme = useCallback((themeName) => {
    document.documentElement.removeAttribute('data-theme');

    if (themeName !== 'light') {
      document.documentElement.setAttribute('data-theme', themeName);
    }

    localStorage.setItem('user-theme', themeName);
    setTheme(themeName);
  }, []);

  /**
   * @description åˆ‡æ¢ä¸»é¢˜
   */
  const toggleTheme = useCallback(() => {
    const currentIndex = themes.indexOf(theme);
    const nextIndex = (currentIndex + 1) % themes.length;
    applyTheme(themes[nextIndex]);
  }, [theme, themes, applyTheme]);

  /**
   * @description è®¾ç½®æŒ‡å®šä¸»é¢˜
   */
  const changeTheme = useCallback((themeName) => {
    if (themes.includes(themeName)) {
      applyTheme(themeName);
    }
  }, [themes, applyTheme]);

  // åˆå§‹åŒ–ä¸»é¢˜
  useEffect(() => {
    const savedTheme = localStorage.getItem('user-theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');

    applyTheme(initialTheme);
  }, [applyTheme]);

  // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

    const handleChange = (e) => {
      if (!localStorage.getItem('user-theme')) {
        applyTheme(e.matches ? 'dark' : 'light');
      }
    };

    mediaQuery.addEventListener('change', handleChange);

    return () => {
      mediaQuery.removeEventListener('change', handleChange);
    };
  }, [applyTheme]);

  return {
    theme,
    themes,
    toggleTheme,
    changeTheme,
    isDark: theme === 'dark',
    isLight: theme === 'light'
  };
}
```

### 4. Vue Composition APIå®ç°

```javascript
import { ref, computed, onMounted, watch } from 'vue';

/**
 * @description Vueä¸»é¢˜ç®¡ç†ç»„åˆå¼å‡½æ•°
 * @returns {Object} ä¸»é¢˜çŠ¶æ€å’Œæ§åˆ¶æ–¹æ³•
 */
export function useTheme() {
  const theme = ref('light');
  const themes = ref(['light', 'dark', 'blue']);

  // è®¡ç®—å±æ€§
  const isDark = computed(() => theme.value === 'dark');
  const isLight = computed(() => theme.value === 'light');

  /**
   * @description åº”ç”¨ä¸»é¢˜
   */
  const applyTheme = (themeName) => {
    if (!themes.value.includes(themeName)) return;

    document.documentElement.removeAttribute('data-theme');

    if (themeName !== 'light') {
      document.documentElement.setAttribute('data-theme', themeName);
    }

    localStorage.setItem('user-theme', themeName);
    theme.value = themeName;
  };

  /**
   * @description åˆ‡æ¢ä¸»é¢˜
   */
  const toggleTheme = () => {
    const currentIndex = themes.value.indexOf(theme.value);
    const nextIndex = (currentIndex + 1) % themes.value.length;
    applyTheme(themes.value[nextIndex]);
  };

  /**
   * @description è®¾ç½®æŒ‡å®šä¸»é¢˜
   */
  const changeTheme = (themeName) => {
    applyTheme(themeName);
  };

  // åˆå§‹åŒ–
  onMounted(() => {
    const savedTheme = localStorage.getItem('user-theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');

    applyTheme(initialTheme);

    // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const handleChange = (e) => {
      if (!localStorage.getItem('user-theme')) {
        applyTheme(e.matches ? 'dark' : 'light');
      }
    };

    mediaQuery.addEventListener('change', handleChange);

    // æ¸…ç†å‡½æ•°
    return () => {
      mediaQuery.removeEventListener('change', handleChange);
    };
  });

  return {
    theme,
    themes,
    isDark,
    isLight,
    toggleTheme,
    changeTheme
  };
}
```

## å®æˆ˜æ¡ˆä¾‹

### 1. å®Œæ•´çš„ä¸»é¢˜åˆ‡æ¢ç»„ä»¶

```javascript
/**
 * @description ä¸»é¢˜åˆ‡æ¢å™¨ç»„ä»¶
 */
class ThemeSwitcher {
  constructor(container) {
    this.container = container;
    this.render();
    this.bindEvents();
  }

  /**
   * @description æ¸²æŸ“ç»„ä»¶HTML
   */
  render() {
    this.container.innerHTML = `
      <div class="theme-switcher">
        <button class="theme-btn" data-theme="light">
          <span class="theme-icon">â˜€ï¸</span>
          <span class="theme-label">æµ…è‰²</span>
        </button>
        <button class="theme-btn" data-theme="dark">
          <span class="theme-icon">ğŸŒ™</span>
          <span class="theme-label">æ·±è‰²</span>
        </button>
        <button class="theme-btn" data-theme="blue">
          <span class="theme-icon">ğŸ’™</span>
          <span class="theme-label">è“è‰²</span>
        </button>
      </div>
    `;

    // æ·»åŠ æ ·å¼
    this.addStyles();
    this.updateActiveState();
  }

  /**
   * @description æ·»åŠ ç»„ä»¶æ ·å¼
   */
  addStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .theme-switcher {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: var(--bg-color);
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .theme-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .theme-btn:hover {
        background: var(--primary-color);
        color: var(--bg-color);
      }

      .theme-btn.active {
        background: var(--primary-color);
        color: var(--bg-color);
      }

      .theme-icon {
        font-size: 16px;
      }
    `;

    if (!document.querySelector('#theme-switcher-styles')) {
      style.id = 'theme-switcher-styles';
      document.head.appendChild(style);
    }
  }

  /**
   * @description ç»‘å®šäº‹ä»¶ç›‘å¬
   */
  bindEvents() {
    this.container.addEventListener('click', (e) => {
      const button = e.target.closest('.theme-btn');
      if (button) {
        const theme = button.dataset.theme;
        window.themeManager.applyTheme(theme);
        this.updateActiveState();
      }
    });

    // ç›‘å¬ä¸»é¢˜å˜åŒ–äº‹ä»¶
    window.addEventListener('themechange', () => {
      this.updateActiveState();
    });
  }

  /**
   * @description æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
   */
  updateActiveState() {
    const currentTheme = window.themeManager.getCurrentTheme();
    const buttons = this.container.querySelectorAll('.theme-btn');

    buttons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.theme === currentTheme);
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
document.addEventListener('DOMContentLoaded', () => {
  const switcherContainer = document.querySelector('#theme-switcher');
  if (switcherContainer) {
    new ThemeSwitcher(switcherContainer);
  }
});
```

### 2. ä¸»é¢˜é…ç½®ç®¡ç†

```javascript
/**
 * @description ä¸»é¢˜é…ç½®ç®¡ç†å™¨
 */
class ThemeConfig {
  constructor() {
    this.themes = {
      light: {
        name: 'æµ…è‰²ä¸»é¢˜',
        colors: {
          primary: '#1976d2',
          secondary: '#dc004e',
          background: '#ffffff',
          text: '#333333',
          border: '#e0e0e0',
          shadow: 'rgba(0, 0, 0, 0.1)'
        }
      },
      dark: {
        name: 'æ·±è‰²ä¸»é¢˜',
        colors: {
          primary: '#90caf9',
          secondary: '#f48fb1',
          background: '#121212',
          text: '#ffffff',
          border: '#333333',
          shadow: 'rgba(255, 255, 255, 0.1)'
        }
      },
      blue: {
        name: 'è“è‰²ä¸»é¢˜',
        colors: {
          primary: '#2196f3',
          secondary: '#ff9800',
          background: '#f3f8ff',
          text: '#1a1a1a',
          border: '#b3d9ff',
          shadow: 'rgba(33, 150, 243, 0.2)'
        }
      }
    };
  }

  /**
   * @description è·å–ä¸»é¢˜é…ç½®
   * @param {string} themeName - ä¸»é¢˜åç§°
   * @returns {Object} ä¸»é¢˜é…ç½®å¯¹è±¡
   */
  getTheme(themeName) {
    return this.themes[themeName] || this.themes.light;
  }

  /**
   * @description åŠ¨æ€ç”ŸæˆCSSå˜é‡
   * @param {string} themeName - ä¸»é¢˜åç§°
   */
  generateCSSVariables(themeName) {
    const theme = this.getTheme(themeName);
    const cssVariables = [];

    Object.entries(theme.colors).forEach(([key, value]) => {
      const cssVarName = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}-color`;
      cssVariables.push(`${cssVarName}: ${value};`);
    });

    return cssVariables.join('\n  ');
  }

  /**
   * @description åŠ¨æ€æ³¨å…¥ä¸»é¢˜æ ·å¼
   */
  injectThemeStyles() {
    let styleContent = ':root {\n';
    styleContent += '  ' + this.generateCSSVariables('light');
    styleContent += '\n}\n\n';

    Object.keys(this.themes).forEach(themeName => {
      if (themeName !== 'light') {
        styleContent += `[data-theme="${themeName}"] {\n`;
        styleContent += '  ' + this.generateCSSVariables(themeName);
        styleContent += '\n}\n\n';
      }
    });

    const styleEl = document.createElement('style');
    styleEl.id = 'dynamic-theme-styles';
    styleEl.textContent = styleContent;

    // ç§»é™¤å·²å­˜åœ¨çš„æ ·å¼
    const existingStyle = document.querySelector('#dynamic-theme-styles');
    if (existingStyle) {
      existingStyle.remove();
    }

    document.head.appendChild(styleEl);
  }

  /**
   * @description æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜
   * @param {string} name - ä¸»é¢˜åç§°
   * @param {Object} config - ä¸»é¢˜é…ç½®
   */
  addTheme(name, config) {
    this.themes[name] = config;
    this.injectThemeStyles();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const themeConfig = new ThemeConfig();
themeConfig.injectThemeStyles();

// æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜
themeConfig.addTheme('green', {
  name: 'ç»¿è‰²ä¸»é¢˜',
  colors: {
    primary: '#4caf50',
    secondary: '#ff5722',
    background: '#f1f8e9',
    text: '#2e7d32',
    border: '#c8e6c9',
    shadow: 'rgba(76, 175, 80, 0.2)'
  }
});
```

## é«˜çº§ç‰¹æ€§

### 1. åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ

```css
/* å¹³æ»‘çš„ä¸»é¢˜åˆ‡æ¢åŠ¨ç”» */
* {
  transition: background-color 0.3s ease,
              color 0.3s ease,
              border-color 0.3s ease,
              box-shadow 0.3s ease;
}

/* ç‰¹æ®Šå…ƒç´ çš„åŠ¨ç”»å¤„ç† */
.theme-transition {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* é¿å…æŸäº›å…ƒç´ çš„åŠ¨ç”»å¹²æ‰° */
.no-transition * {
  transition: none !important;
}
```

### 2. ä¸»é¢˜é¢„åŠ è½½

```javascript
/**
 * @description ä¸»é¢˜é¢„åŠ è½½å™¨
 */
class ThemePreloader {
  constructor() {
    this.preloadedThemes = new Set();
  }

  /**
   * @description é¢„åŠ è½½ä¸»é¢˜èµ„æº
   * @param {string} themeName - ä¸»é¢˜åç§°
   */
  async preloadTheme(themeName) {
    if (this.preloadedThemes.has(themeName)) {
      return;
    }

    try {
      // é¢„åŠ è½½ä¸»é¢˜ç›¸å…³çš„CSSæ–‡ä»¶
      if (themeName !== 'light') {
        await this.loadCSS(`/themes/${themeName}.css`);
      }

      // é¢„åŠ è½½ä¸»é¢˜ç›¸å…³çš„å›¾ç‰‡èµ„æº
      await this.preloadImages(themeName);

      this.preloadedThemes.add(themeName);
      console.log(`Theme ${themeName} preloaded successfully`);
    } catch (error) {
      console.error(`Failed to preload theme ${themeName}:`, error);
    }
  }

  /**
   * @description åŠ è½½CSSæ–‡ä»¶
   * @param {string} url - CSSæ–‡ä»¶URL
   */
  loadCSS(url) {
    return new Promise((resolve, reject) => {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = url;
      link.onload = resolve;
      link.onerror = reject;
      document.head.appendChild(link);
    });
  }

  /**
   * @description é¢„åŠ è½½ä¸»é¢˜å›¾ç‰‡
   * @param {string} themeName - ä¸»é¢˜åç§°
   */
  async preloadImages(themeName) {
    const imageUrls = this.getThemeImages(themeName);

    const promises = imageUrls.map(url => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
      });
    });

    await Promise.all(promises);
  }

  /**
   * @description è·å–ä¸»é¢˜ç›¸å…³çš„å›¾ç‰‡URLåˆ—è¡¨
   * @param {string} themeName - ä¸»é¢˜åç§°
   * @returns {string[]} å›¾ç‰‡URLæ•°ç»„
   */
  getThemeImages(themeName) {
    const imageMap = {
      dark: ['/images/dark-logo.png', '/images/dark-bg.jpg'],
      blue: ['/images/blue-logo.png', '/images/blue-bg.jpg'],
      light: ['/images/light-logo.png', '/images/light-bg.jpg']
    };

    return imageMap[themeName] || [];
  }

  /**
   * @description é¢„åŠ è½½æ‰€æœ‰ä¸»é¢˜
   */
  async preloadAllThemes() {
    const themes = ['light', 'dark', 'blue'];
    await Promise.all(themes.map(theme => this.preloadTheme(theme)));
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const preloader = new ThemePreloader();

// åœ¨ç©ºé—²æ—¶é—´é¢„åŠ è½½
if ('requestIdleCallback' in window) {
  requestIdleCallback(() => {
    preloader.preloadAllThemes();
  });
} else {
  setTimeout(() => {
    preloader.preloadAllThemes();
  }, 1000);
}
```

### 3. è‡ªé€‚åº”ä¸»é¢˜åˆ‡æ¢

```javascript
/**
 * @description è‡ªé€‚åº”ä¸»é¢˜ç®¡ç†å™¨
 */
class AdaptiveThemeManager extends ThemeManager {
  constructor() {
    super();
    this.timeBasedSwitching = false;
    this.locationBasedSwitching = false;
  }

  /**
   * @description å¯ç”¨åŸºäºæ—¶é—´çš„ä¸»é¢˜åˆ‡æ¢
   */
  enableTimeBasedSwitching() {
    this.timeBasedSwitching = true;
    this.checkTimeBasedTheme();

    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    this.timeInterval = setInterval(() => {
      this.checkTimeBasedTheme();
    }, 60 * 60 * 1000);
  }

  /**
   * @description æ£€æŸ¥åŸºäºæ—¶é—´çš„ä¸»é¢˜
   */
  checkTimeBasedTheme() {
    if (!this.timeBasedSwitching) return;

    const hour = new Date().getHours();
    let suggestedTheme;

    if (hour >= 6 && hour < 18) {
      suggestedTheme = 'light'; // ç™½å¤©ä½¿ç”¨æµ…è‰²ä¸»é¢˜
    } else {
      suggestedTheme = 'dark';  // å¤œæ™šä½¿ç”¨æ·±è‰²ä¸»é¢˜
    }

    // åªåœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®æ—¶æ‰è‡ªåŠ¨åˆ‡æ¢
    if (!localStorage.getItem(this.storageKey)) {
      this.applyTheme(suggestedTheme);
    }
  }

  /**
   * @description å¯ç”¨åŸºäºåœ°ç†ä½ç½®çš„ä¸»é¢˜åˆ‡æ¢
   */
  async enableLocationBasedSwitching() {
    this.locationBasedSwitching = true;

    try {
      const position = await this.getCurrentPosition();
      const { latitude, longitude } = position.coords;

      // æ ¹æ®åœ°ç†ä½ç½®è·å–æ—¥å‡ºæ—¥è½æ—¶é—´
      const sunTimes = await this.getSunTimes(latitude, longitude);
      this.scheduleThemeByLocation(sunTimes);
    } catch (error) {
      console.warn('æ— æ³•è·å–åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå›é€€åˆ°æ—¶é—´åŸºå‡†åˆ‡æ¢', error);
      this.enableTimeBasedSwitching();
    }
  }

  /**
   * @description è·å–å½“å‰ä½ç½®
   */
  getCurrentPosition() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error('Geolocation is not supported'));
        return;
      }

      navigator.geolocation.getCurrentPosition(resolve, reject, {
        timeout: 10000,
        maximumAge: 24 * 60 * 60 * 1000 // 24å°æ—¶ç¼“å­˜
      });
    });
  }

  /**
   * @description è·å–æ—¥å‡ºæ—¥è½æ—¶é—´
   * @param {number} latitude - çº¬åº¦
   * @param {number} longitude - ç»åº¦
   */
  async getSunTimes(latitude, longitude) {
    // è¿™é‡Œå¯ä»¥è°ƒç”¨ç¬¬ä¸‰æ–¹APIè·å–ç²¾ç¡®çš„æ—¥å‡ºæ—¥è½æ—¶é—´
    // ç¤ºä¾‹ä½¿ç”¨ç®€åŒ–è®¡ç®—
    const today = new Date();
    return {
      sunrise: new Date(today.setHours(6, 0, 0, 0)),
      sunset: new Date(today.setHours(18, 0, 0, 0))
    };
  }

  /**
   * @description æ ¹æ®åœ°ç†ä½ç½®å®‰æ’ä¸»é¢˜åˆ‡æ¢
   */
  scheduleThemeByLocation(sunTimes) {
    const now = new Date();
    const { sunrise, sunset } = sunTimes;

    if (now >= sunrise && now < sunset) {
      this.applyTheme('light');
    } else {
      this.applyTheme('dark');
    }

    // è®¾ç½®ä¸‹æ¬¡åˆ‡æ¢çš„å®šæ—¶å™¨
    const nextSwitch = now < sunrise ? sunrise :
                      now < sunset ? sunset :
                      new Date(sunrise.getTime() + 24 * 60 * 60 * 1000);

    const timeUntilSwitch = nextSwitch.getTime() - now.getTime();

    setTimeout(() => {
      this.scheduleThemeByLocation(sunTimes);
    }, timeUntilSwitch);
  }

  /**
   * @description æ¸…ç†è‡ªé€‚åº”åŠŸèƒ½
   */
  destroy() {
    if (this.timeInterval) {
      clearInterval(this.timeInterval);
    }
    this.timeBasedSwitching = false;
    this.locationBasedSwitching = false;
  }
}
```

## å…¼å®¹æ€§å¤„ç†

### 1. CSSå˜é‡é™çº§æ–¹æ¡ˆ

```css
/* ä¸ºä¸æ”¯æŒCSSå˜é‡çš„æµè§ˆå™¨æä¾›é™çº§æ–¹æ¡ˆ */
.app {
  /* é™çº§é¢œè‰²å€¼ */
  background-color: #ffffff;
  color: #333333;

  /* CSSå˜é‡å€¼ï¼ˆä¼šè¦†ç›–ä¸Šé¢çš„å€¼ï¼Œå¦‚æœæ”¯æŒçš„è¯ï¼‰ */
  background-color: var(--bg-color, #ffffff);
  color: var(--text-color, #333333);
}

/* ä½¿ç”¨PostCSSæ’ä»¶è‡ªåŠ¨ç”Ÿæˆé™çº§ä»£ç  */
```

### 2. JavaScriptå…¼å®¹æ€§æ£€æµ‹

```javascript
/**
 * @description æ£€æµ‹æµè§ˆå™¨ç‰¹æ€§æ”¯æŒ
 */
class CompatibilityChecker {
  static supportsCSSVariables() {
    return window.CSS && CSS.supports && CSS.supports('color', 'var(--test)');
  }

  static supportsLocalStorage() {
    try {
      const test = 'test';
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
      return true;
    } catch (e) {
      return false;
    }
  }

  static supportsMediaQueries() {
    return window.matchMedia !== undefined;
  }

  static getCompatibilityInfo() {
    return {
      cssVariables: this.supportsCSSVariables(),
      localStorage: this.supportsLocalStorage(),
      mediaQueries: this.supportsMediaQueries(),
      customEvents: typeof CustomEvent === 'function'
    };
  }
}

/**
 * @description å…¼å®¹æ€§ä¸»é¢˜ç®¡ç†å™¨
 */
class CompatibleThemeManager {
  constructor() {
    this.compatibility = CompatibilityChecker.getCompatibilityInfo();
    this.fallbackThemes = {
      light: {
        backgroundColor: '#ffffff',
        color: '#333333',
        borderColor: '#e0e0e0'
      },
      dark: {
        backgroundColor: '#121212',
        color: '#ffffff',
        borderColor: '#333333'
      }
    };

    this.init();
  }

  init() {
    if (this.compatibility.cssVariables) {
      // ä½¿ç”¨ç°ä»£CSSå˜é‡æ–¹æ¡ˆ
      this.modernThemeManager = new ThemeManager();
    } else {
      // ä½¿ç”¨é™çº§æ–¹æ¡ˆ
      this.useFallbackApproach();
    }
  }

  /**
   * @description é™çº§æ–¹æ¡ˆå®ç°
   */
  useFallbackApproach() {
    console.warn('CSSå˜é‡ä¸è¢«æ”¯æŒï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');

    this.currentTheme = 'light';
    this.applyFallbackTheme(this.currentTheme);
  }

  /**
   * @description åº”ç”¨é™çº§ä¸»é¢˜
   */
  applyFallbackTheme(theme) {
    const theme = this.fallbackThemes[theme];
    if (!theme) return;

    // ç›´æ¥ä¿®æ”¹æ ·å¼
    document.body.style.backgroundColor = theme.backgroundColor;
    document.body.style.color = theme.color;

    // ä¸ºæ‰€æœ‰ç›¸å…³å…ƒç´ åº”ç”¨æ ·å¼
    const elements = document.querySelectorAll('.theme-element');
    elements.forEach(el => {
      Object.assign(el.style, theme);
    });

    this.currentTheme = theme;

    // ä¿å­˜åˆ°localStorageï¼ˆå¦‚æœæ”¯æŒï¼‰
    if (this.compatibility.localStorage) {
      localStorage.setItem('user-theme', theme);
    }
  }

  /**
   * @description åˆ‡æ¢ä¸»é¢˜ï¼ˆå…¼å®¹ç‰ˆæœ¬ï¼‰
   */
  toggleTheme() {
    if (this.compatibility.cssVariables && this.modernThemeManager) {
      this.modernThemeManager.toggleTheme();
    } else {
      const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
      this.applyFallbackTheme(newTheme);
    }
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. é˜²æŠ–ä¼˜åŒ–

```javascript
/**
 * @description é˜²æŠ–å‡½æ•°
 * @param {Function} func - è¦æ‰§è¡Œçš„å‡½æ•°
 * @param {number} delay - å»¶è¿Ÿæ—¶é—´
 */
function debounce(func, delay) {
  let timeoutId;
  return function (...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func.apply(this, args), delay);
  };
}

/**
 * @description ä¼˜åŒ–çš„ä¸»é¢˜ç®¡ç†å™¨
 */
class OptimizedThemeManager extends ThemeManager {
  constructor() {
    super();

    // é˜²æŠ–çš„ä¸»é¢˜åº”ç”¨å‡½æ•°
    this.debouncedApplyTheme = debounce(this.applyTheme.bind(this), 100);

    // æ‰¹å¤„ç†æ ·å¼æ›´æ–°
    this.pendingUpdates = new Set();
    this.updateScheduled = false;
  }

  /**
   * @description æ‰¹é‡æ›´æ–°æ ·å¼
   */
  batchStyleUpdate(element, styles) {
    this.pendingUpdates.add({ element, styles });

    if (!this.updateScheduled) {
      this.updateScheduled = true;

      // ä½¿ç”¨ requestAnimationFrame æ‰¹å¤„ç†æ›´æ–°
      requestAnimationFrame(() => {
        this.flushStyleUpdates();
      });
    }
  }

  /**
   * @description æ‰§è¡Œæ‰¹é‡æ ·å¼æ›´æ–°
   */
  flushStyleUpdates() {
    this.pendingUpdates.forEach(({ element, styles }) => {
      Object.assign(element.style, styles);
    });

    this.pendingUpdates.clear();
    this.updateScheduled = false;
  }

  /**
   * @description ä¼˜åŒ–çš„ä¸»é¢˜åº”ç”¨
   */
  applyTheme(theme) {
    // ä½¿ç”¨ CSS ç±»åˆ‡æ¢è€Œä¸æ˜¯é€ä¸ªä¿®æ”¹æ ·å¼
    document.documentElement.className =
      document.documentElement.className.replace(/theme-\w+/g, '');

    if (theme !== 'light') {
      document.documentElement.classList.add(`theme-${theme}`);
    }

    // æœ€å°åŒ– DOM æ“ä½œ
    this.currentTheme = theme;

    // å¼‚æ­¥ä¿å­˜åˆ° localStorage
    setTimeout(() => {
      localStorage.setItem(this.storageKey, theme);
    }, 0);

    // å¼‚æ­¥è§¦å‘äº‹ä»¶
    setTimeout(() => {
      this.dispatchThemeChange(theme);
    }, 0);
  }
}
```

### 2. å†…å­˜ç®¡ç†

```javascript
/**
 * @description ä¸»é¢˜èµ„æºç®¡ç†å™¨
 */
class ThemeResourceManager {
  constructor() {
    this.styleSheets = new Map();
    this.eventListeners = new WeakMap();
    this.observers = new Set();
  }

  /**
   * @description æ·»åŠ ä¸»é¢˜æ ·å¼è¡¨
   */
  addStyleSheet(themeName, url) {
    if (this.styleSheets.has(themeName)) {
      return this.styleSheets.get(themeName);
    }

    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = url;
    link.disabled = true; // é»˜è®¤ç¦ç”¨

    document.head.appendChild(link);
    this.styleSheets.set(themeName, link);

    return link;
  }

  /**
   * @description æ¿€æ´»ä¸»é¢˜æ ·å¼è¡¨
   */
  activateTheme(themeName) {
    // ç¦ç”¨æ‰€æœ‰ä¸»é¢˜
    this.styleSheets.forEach(link => {
      link.disabled = true;
    });

    // å¯ç”¨æŒ‡å®šä¸»é¢˜
    const targetSheet = this.styleSheets.get(themeName);
    if (targetSheet) {
      targetSheet.disabled = false;
    }
  }

  /**
   * @description æ¸…ç†èµ„æº
   */
  destroy() {
    // ç§»é™¤æ ·å¼è¡¨
    this.styleSheets.forEach(link => {
      if (link.parentNode) {
        link.parentNode.removeChild(link);
      }
    });
    this.styleSheets.clear();

    // æ¸…ç†è§‚å¯Ÿè€…
    this.observers.forEach(observer => {
      if (observer.disconnect) {
        observer.disconnect();
      }
    });
    this.observers.clear();

    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    this.eventListeners = new WeakMap();
  }
}
```

## é¢è¯•å¸¸è§é—®é¢˜

### 1. å¦‚ä½•å®ç°ä¸€é”®æ¢è‚¤åŠŸèƒ½ï¼Ÿ

**ç­”**ï¼š
å®ç°ä¸€é”®æ¢è‚¤åŠŸèƒ½ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š

```javascript
// 1. CSSå˜é‡æ–¹æ¡ˆï¼ˆæ¨èï¼‰
// å®šä¹‰CSSå˜é‡
:root {
  --primary-color: #1976d2;
  --bg-color: #ffffff;
}

[data-theme="dark"] {
  --primary-color: #90caf9;
  --bg-color: #121212;
}

// JavaScriptåˆ‡æ¢
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

  if (newTheme === 'light') {
    document.documentElement.removeAttribute('data-theme');
  } else {
    document.documentElement.setAttribute('data-theme', newTheme);
  }

  localStorage.setItem('theme', newTheme);
}

// 2. CSSç±»åˆ‡æ¢æ–¹æ¡ˆ
function switchThemeByClass(theme) {
  document.body.className = document.body.className.replace(/theme-\w+/g, '');
  document.body.classList.add(`theme-${theme}`);
}

// 3. åŠ¨æ€æ ·å¼æ³¨å…¥æ–¹æ¡ˆ
function injectThemeStyles(theme) {
  const existingStyle = document.getElementById('dynamic-theme');
  if (existingStyle) {
    existingStyle.remove();
  }

  const style = document.createElement('style');
  style.id = 'dynamic-theme';
  style.textContent = getThemeCSS(theme);
  document.head.appendChild(style);
}
```

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| CSSå˜é‡ | æ€§èƒ½å¥½ã€è¯­æ³•ç®€æ´ã€æµè§ˆå™¨æ”¯æŒå¥½ | IEä¸æ”¯æŒ | ç°ä»£æµè§ˆå™¨é¡¹ç›® |
| CSSç±»åˆ‡æ¢ | å…¼å®¹æ€§å¼ºã€çµæ´»åº¦é«˜ | CSSæ–‡ä»¶è¾ƒå¤§ | éœ€è¦å…¼å®¹è€æµè§ˆå™¨ |
| åŠ¨æ€æ³¨å…¥ | æœ€çµæ´»ã€å¯åŠ¨æ€ç”Ÿæˆ | æ€§èƒ½è¾ƒå·®ã€è°ƒè¯•å›°éš¾ | å¤æ‚è‡ªå®šä¹‰éœ€æ±‚ |

### 2. å¦‚ä½•ä¿æŒä¸»é¢˜åˆ‡æ¢çš„æ€§èƒ½ï¼Ÿ

**ç­”**ï¼š
ä¸»é¢˜åˆ‡æ¢çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š

```javascript
// 1. ä½¿ç”¨CSSå˜é‡é¿å…å¤§é‡DOMæ“ä½œ
// ä¸å¥½çš„åšæ³•
function badThemeSwitch() {
  const elements = document.querySelectorAll('.theme-element');
  elements.forEach(el => {
    el.style.backgroundColor = newBgColor;
    el.style.color = newTextColor;
  });
}

// å¥½çš„åšæ³•
function goodThemeSwitch() {
  document.documentElement.style.setProperty('--bg-color', newBgColor);
  document.documentElement.style.setProperty('--text-color', newTextColor);
}

// 2. ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–é¢‘ç¹åˆ‡æ¢
const debouncedThemeSwitch = debounce(applyTheme, 100);

// 3. é¢„åŠ è½½ä¸»é¢˜èµ„æº
class ThemePreloader {
  async preloadTheme(themeName) {
    const cssUrl = `/themes/${themeName}.css`;
    const link = document.createElement('link');
    link.rel = 'preload';
    link.as = 'style';
    link.href = cssUrl;
    document.head.appendChild(link);
  }
}

// 4. ä½¿ç”¨CSS transitionä¼˜åŒ–è§†è§‰æ•ˆæœ
.theme-transition {
  transition: background-color 0.3s ease, color 0.3s ease;
}

// 5. æ‰¹é‡å¤„ç†æ ·å¼æ›´æ–°
function batchStyleUpdate() {
  requestAnimationFrame(() => {
    // åœ¨ä¸‹ä¸€ä¸ªåŠ¨ç”»å¸§ä¸­æ‰¹é‡æ›´æ–°æ ·å¼
    applyAllThemeStyles();
  });
}
```

**æ€§èƒ½ä¼˜åŒ–åŸåˆ™**ï¼š
- å‡å°‘DOMæ“ä½œæ¬¡æ•°
- ä½¿ç”¨CSSå˜é‡è€Œéç›´æ¥ä¿®æ”¹æ ·å¼
- é¢„åŠ è½½ä¸»é¢˜èµ„æº
- ä½¿ç”¨é€‚å½“çš„é˜²æŠ–ç­–ç•¥
- æ‰¹å¤„ç†æ ·å¼æ›´æ–°

### 3. å¦‚ä½•å¤„ç†ä¸»é¢˜åˆ‡æ¢çš„å…¼å®¹æ€§é—®é¢˜ï¼Ÿ

**ç­”**ï¼š
ä¸»é¢˜åˆ‡æ¢çš„å…¼å®¹æ€§å¤„ç†éœ€è¦è€ƒè™‘å¤šä¸ªæ–¹é¢ï¼š

```javascript
// 1. CSSå˜é‡å…¼å®¹æ€§æ£€æµ‹
function supportsCSSVariables() {
  return window.CSS && CSS.supports && CSS.supports('color', 'var(--test)');
}

// 2. é™çº§æ–¹æ¡ˆå®ç°
class CompatibleTheme {
  constructor() {
    this.useModernApproach = supportsCSSVariables();

    if (!this.useModernApproach) {
      this.fallbackThemes = {
        light: { backgroundColor: '#fff', color: '#333' },
        dark: { backgroundColor: '#333', color: '#fff' }
      };
    }
  }

  applyTheme(theme) {
    if (this.useModernApproach) {
      document.documentElement.setAttribute('data-theme', theme);
    } else {
      this.applyFallbackTheme(theme);
    }
  }

  applyFallbackTheme(theme) {
    const styles = this.fallbackThemes[theme];
    Object.assign(document.body.style, styles);

    // ä¸ºå…³é”®å…ƒç´ åº”ç”¨æ ·å¼
    document.querySelectorAll('.theme-element').forEach(el => {
      Object.assign(el.style, styles);
    });
  }
}

// 3. æ¸è¿›å¢å¼ºç­–ç•¥
// åŸºç¡€CSSï¼ˆæ‰€æœ‰æµè§ˆå™¨ï¼‰
.app { background: #fff; color: #333; }

// ç°ä»£æµè§ˆå™¨å¢å¼º
@supports (color: var(--test)) {
  .app {
    background: var(--bg-color);
    color: var(--text-color);
  }
}

// 4. polyfillæ”¯æŒ
if (!supportsCSSVariables()) {
  // åŠ è½½CSSå˜é‡polyfill
  loadScript('https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2');
}
```

**å…¼å®¹æ€§å¤„ç†ç­–ç•¥**ï¼š
- ç‰¹æ€§æ£€æµ‹ + æ¸è¿›å¢å¼º
- æä¾›é™çº§æ–¹æ¡ˆ
- ä½¿ç”¨é€‚å½“çš„polyfill
- ä¿è¯åŸºç¡€åŠŸèƒ½åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­å¯ç”¨

### 4. å¦‚ä½•å®ç°ä¸»é¢˜çš„æŒä¹…åŒ–å­˜å‚¨ï¼Ÿ

**ç­”**ï¼š
ä¸»é¢˜æŒä¹…åŒ–å­˜å‚¨éœ€è¦è€ƒè™‘å¤šç§å­˜å‚¨æ–¹å¼å’Œåœºæ™¯ï¼š

```javascript
// 1. localStorageå­˜å‚¨ï¼ˆæœ€å¸¸ç”¨ï¼‰
class ThemeStorage {
  constructor() {
    this.storageKey = 'user-theme-preference';
    this.defaultTheme = 'light';
  }

  saveTheme(theme) {
    try {
      localStorage.setItem(this.storageKey, theme);
      return true;
    } catch (error) {
      console.warn('æ— æ³•ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°localStorage:', error);
      return this.fallbackSave(theme);
    }
  }

  loadTheme() {
    try {
      return localStorage.getItem(this.storageKey) || this.getSystemPreference();
    } catch (error) {
      console.warn('æ— æ³•ä»localStorageè¯»å–ä¸»é¢˜è®¾ç½®:', error);
      return this.fallbackLoad();
    }
  }

  // 2. Cookieé™çº§æ–¹æ¡ˆ
  fallbackSave(theme) {
    document.cookie = `${this.storageKey}=${theme}; max-age=31536000; path=/`;
  }

  fallbackLoad() {
    const match = document.cookie.match(new RegExp('(^| )' + this.storageKey + '=([^;]+)'));
    return match ? match[2] : this.getSystemPreference();
  }

  // 3. æ£€æµ‹ç³»ç»Ÿåå¥½
  getSystemPreference() {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return this.defaultTheme;
  }

  // 4. ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
  watchSystemChanges(callback) {
    if (window.matchMedia) {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addListener(callback);
      return () => mediaQuery.removeListener(callback);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const themeStorage = new ThemeStorage();

// ä¿å­˜ä¸»é¢˜
themeStorage.saveTheme('dark');

// åŠ è½½ä¸»é¢˜
const savedTheme = themeStorage.loadTheme();

// ç›‘å¬ç³»ç»Ÿå˜åŒ–
const unwatch = themeStorage.watchSystemChanges((e) => {
  if (!localStorage.getItem('user-theme-preference')) {
    // åªæœ‰ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®æ—¶æ‰è·Ÿéšç³»ç»Ÿ
    applyTheme(e.matches ? 'dark' : 'light');
  }
});
```

**å­˜å‚¨ç­–ç•¥ä¼˜å…ˆçº§**ï¼š
1. ç”¨æˆ·æ‰‹åŠ¨è®¾ç½® > ç³»ç»Ÿåå¥½ > é»˜è®¤ä¸»é¢˜
2. localStorage > Cookie > å†…å­˜å­˜å‚¨
3. æ”¯æŒç³»ç»Ÿä¸»é¢˜å˜åŒ–ç›‘å¬
4. æä¾›æ¸…é™¤è®¾ç½®å›åˆ°é»˜è®¤çš„åŠŸèƒ½

### 5. å¦‚ä½•è®¾è®¡å¯æ‰©å±•çš„ä¸»é¢˜ç³»ç»Ÿï¼Ÿ

**ç­”**ï¼š
å¯æ‰©å±•çš„ä¸»é¢˜ç³»ç»Ÿéœ€è¦è‰¯å¥½çš„æ¶æ„è®¾è®¡ï¼š

```javascript
// 1. ä¸»é¢˜é…ç½®æŠ½è±¡
class ThemeConfig {
  constructor() {
    this.themes = new Map();
    this.variables = new Map();
  }

  // æ³¨å†Œä¸»é¢˜
  registerTheme(name, config) {
    this.themes.set(name, {
      name: config.name,
      variables: config.variables,
      assets: config.assets || {},
      extends: config.extends // æ”¯æŒä¸»é¢˜ç»§æ‰¿
    });
  }

  // æ³¨å†Œå˜é‡
  registerVariable(name, defaultValue, description) {
    this.variables.set(name, {
      name,
      defaultValue,
      description,
      type: typeof defaultValue
    });
  }

  // è·å–åˆå¹¶åçš„ä¸»é¢˜é…ç½®
  getThemeConfig(themeName) {
    const theme = this.themes.get(themeName);
    if (!theme) return null;

    let config = { ...theme };

    // å¤„ç†ä¸»é¢˜ç»§æ‰¿
    if (theme.extends) {
      const parentConfig = this.getThemeConfig(theme.extends);
      if (parentConfig) {
        config.variables = { ...parentConfig.variables, ...config.variables };
        config.assets = { ...parentConfig.assets, ...config.assets };
      }
    }

    return config;
  }
}

// 2. æ’ä»¶ç³»ç»Ÿ
class ThemePlugin {
  constructor(name, options = {}) {
    this.name = name;
    this.options = options;
  }

  install(themeManager) {
    // æ’ä»¶å®‰è£…é€»è¾‘
  }

  uninstall(themeManager) {
    // æ’ä»¶å¸è½½é€»è¾‘
  }
}

// åŠ¨ç”»æ’ä»¶ç¤ºä¾‹
class ThemeAnimationPlugin extends ThemePlugin {
  install(themeManager) {
    themeManager.on('theme-change', (event) => {
      this.animateThemeChange(event.from, event.to);
    });
  }

  animateThemeChange(fromTheme, toTheme) {
    document.body.classList.add('theme-changing');

    setTimeout(() => {
      document.body.classList.remove('theme-changing');
    }, 300);
  }
}

// 3. äº‹ä»¶ç³»ç»Ÿ
class ThemeEventManager {
  constructor() {
    this.listeners = new Map();
  }

  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }
    this.listeners.get(event).add(callback);
  }

  off(event, callback) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).delete(callback);
    }
  }

  emit(event, data) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback => {
        try {
          callback(data);
        } catch (error) {
          console.error(`Error in theme event listener:`, error);
        }
      });
    }
  }
}

// 4. æ‰©å±•çš„ä¸»é¢˜ç®¡ç†å™¨
class ExtensibleThemeManager extends ThemeEventManager {
  constructor() {
    super();
    this.config = new ThemeConfig();
    this.plugins = new Map();
    this.currentTheme = 'light';
  }

  // ä½¿ç”¨æ’ä»¶
  use(plugin) {
    if (this.plugins.has(plugin.name)) {
      console.warn(`Plugin ${plugin.name} already installed`);
      return;
    }

    plugin.install(this);
    this.plugins.set(plugin.name, plugin);
  }

  // åº”ç”¨ä¸»é¢˜
  applyTheme(themeName) {
    const oldTheme = this.currentTheme;
    const themeConfig = this.config.getThemeConfig(themeName);

    if (!themeConfig) {
      console.error(`Theme ${themeName} not found`);
      return;
    }

    // è§¦å‘ä¸»é¢˜å˜åŒ–å‰äº‹ä»¶
    this.emit('theme-change-before', {
      from: oldTheme,
      to: themeName,
      config: themeConfig
    });

    // åº”ç”¨CSSå˜é‡
    Object.entries(themeConfig.variables).forEach(([key, value]) => {
      document.documentElement.style.setProperty(`--${key}`, value);
    });

    this.currentTheme = themeName;

    // è§¦å‘ä¸»é¢˜å˜åŒ–åäº‹ä»¶
    this.emit('theme-change', {
      from: oldTheme,
      to: themeName,
      config: themeConfig
    });
  }

  // åˆ›å»ºä¸»é¢˜
  createTheme(name, config) {
    this.config.registerTheme(name, config);
    this.emit('theme-created', { name, config });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const themeManager = new ExtensibleThemeManager();

// æ³¨å†Œä¸»é¢˜
themeManager.createTheme('custom-blue', {
  name: 'è‡ªå®šä¹‰è“è‰²ä¸»é¢˜',
  variables: {
    'primary-color': '#2196f3',
    'bg-color': '#f3f8ff',
    'text-color': '#1a1a1a'
  },
  extends: 'light' // ç»§æ‰¿lightä¸»é¢˜
});

// ä½¿ç”¨æ’ä»¶
themeManager.use(new ThemeAnimationPlugin());

// ç›‘å¬ä¸»é¢˜å˜åŒ–
themeManager.on('theme-change', (event) => {
  console.log(`ä¸»é¢˜ä» ${event.from} åˆ‡æ¢åˆ° ${event.to}`);
});
```

**å¯æ‰©å±•è®¾è®¡åŸåˆ™**ï¼š
- é…ç½®ä¸å®ç°åˆ†ç¦»
- æ”¯æŒä¸»é¢˜ç»§æ‰¿å’Œç»„åˆ
- æä¾›æ’ä»¶æœºåˆ¶
- äº‹ä»¶é©±åŠ¨çš„æ¶æ„
- è‰¯å¥½çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
